<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clima</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>

<body>

<nav class="navbar bg-body-terciary">
    <div class="container">
        <a class="navbar-brand" href="#">
            <img src="Sol.png" alt="" id="logo">
        </a>
    </div>
</nav>

<div class="container">
    <div class="row">

        <div class="col-lg-7">
            <div class="col-lg-12">
                <h1>Como Funciona</h1>
                <p id="pbranco">Para obter informações detalhadas sobre o clima, basta escolher a cidade desejada no campo de busca. Após a seleção, os dados climáticos serão exibidos automaticamente, incluindo informações sobre a temperatura máxima e mínima, níveis de umidade e velocidade do vento.</p>
                <h1>Desenvolvimento</h1>
                <p id="pbranco">Este sistema foi desenvolvido utilizando a API OpenWeather, uma das fontes mais confiáveis e abrangentes de dados meteorológicos em tempo real, fornecendo informações precisas sobre temperatura, umidade, vento, condições climáticas e previsões. Através dessa integração, os usuários podem acessar dados atualizados e detalhados para qualquer localidade ao redor do mundo, facilitando a tomada de decisões em atividades dependentes do clima, como viagens, planejamento de eventos, e até mesmo a agricultura.</p>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="p-3 shadow rounded">
                <form id="Pesquisar" class="d-flex justify-content-end mb-3">
                    <i class="fa-solid fa-location-dot me-2"></i>
                    <input type="search" class="form-control me-2" name="cidade" id="cidade" placeholder="Buscar Cidade">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </form>

                <div id="weather">
                    <h1 class="text-center" id="title">Chapeco, BR</h1>
                    <div id="temp" class="d-flex align-items-center">
                        <img id="temp_img" src="https://openweathermap.org/img/wn/04d@2x.png" alt="Tempo">
                        <div class="ms-3">
                            <p id="temp_value" class="fs-1"><sup>Cº</sup></p>
                            <p id="temp_description" class="text-muted"></p>
                        </div>
                    </div>
                    <div id="other_infos" class="mt-4">
                        <div class="info d-flex align-items-center" id="temp_max_container">
                            <i class="fa-solid fa-temperature-high me-2"></i>
                            <div>
                                <h2 class="h6">Temp. max</h2>
                                <p id="temp_max"><sup>Cº</sup></p>
                            </div>
                        </div>
                        <div class="info d-flex align-items-center" id="temp_min_container">
                            <i class="fa-solid fa-temperature-low me-2"></i>
                            <div>
                                <h2 class="h6">Temp. min</h2>
                                <p id="temp_min"><sup>Cº</sup></p>
                            </div>
                        </div>
                        <div class="info d-flex align-items-center mt-2">
                            <i class="fa-solid fa-droplet me-2"></i>
                            <div>
                                <h2 class="h6">Humidade</h2>
                                <p id="humidity">%</p>
                            </div>
                        </div>
                        <div class="info d-flex align-items-center mt-2">
                            <i class="fa-solid fa-wind me-2"></i>
                            <div>
                                <h2 class="h6">Vento</h2>
                                <p id="wind">km/h</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="alert"></div>
                <button class="btn btn-warning btn-sm mt-4" onclick="fetchLogs()">Exibir Logs</button>
                <div id="logs-container" class="mt-4"></div> <!-- Container para exibir os logs -->
            </div>
        </div>

    </div>
</div>

<footer>
    <p>Elian Lucion - Sistemas de Informação</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    const matricula = "435504"; // Substitua pela matrícula correta

    function inicio() {
        document.querySelector('#Pesquisar').addEventListener('submit', (event) => {
            event.preventDefault();
            var cidade = document.querySelector('#cidade').value;
            if (!cidade) {
                document.querySelector("#weather").classList.remove('show');
                mostrarAlerta('Você precisa digitar uma cidade...');
                return;
            }
            buscarClima(cidade);
        });
    }

    async function buscarClima(cidade) {
        var apiKey = '9ff164aa1f1ef36138bfb6a314db61ed';
        var apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURI(cidade)}&appid=${apiKey}&units=metric&lang=pt_br`;

        var res = await fetch(apiUrl)
            .then((resposta) => { return resposta.json(); });
        console.log(res);

        if (res.cod === 200) {
            var dados = {
                cidade: res.name,
                pais: res.sys.country,
                temperatura: res.main.temp,
                tempMax: res.main.temp_max,
                tempMin: res.main.temp_min,
                descricao: res.weather[0].description,
                icone: res.weather[0].icon,
                vento: res.wind.speed,
                umidade: res.main.humidity
            };
            mostrarInfo(dados);
            registrarLog('BuscarClima', `Clima para ${cidade} mostrado`); // Log do clima
        } else {
            document.querySelector("#weather").classList.remove('show');
            mostrarAlerta(`Não foi possível localizar... Tente novamente`);
        }
    }

    function mostrarInfo(dados) {
        document.querySelector("#weather").classList.add('show');
        document.querySelector('#title').innerHTML = `${dados.cidade}, ${dados.pais}`;
        document.querySelector('#temp_value').innerHTML = `${dados.temperatura.toFixed(1).toString().replace('.', ',')} <sup>C°</sup>`;
        document.querySelector('#temp_description').innerHTML = dados.descricao;
        document.querySelector('#temp_max').innerHTML = `${dados.tempMax.toFixed(1).toString().replace('.', ',')} <sup>C°</sup>`;
        document.querySelector('#temp_min').innerHTML = `${dados.tempMin.toFixed(1).toString().replace('.', ',')} <sup>C°</sup>`;
        document.querySelector('#humidity').innerHTML = `${dados.umidade}%`;
        document.querySelector('#wind').innerHTML = `${dados.vento} km/h`;
        document.querySelector('#temp_img').setAttribute("src", `https://openweathermap.org/img/wn/${dados.icone}@2x.png`);
    }

    function mostrarAlerta(msg) {
        var alert = document.createElement("div");
        alert.innerHTML = msg;
        alert.classList.add("alert", "alert-danger", "mt-3");
        document.querySelector("#alert").innerHTML = '';
        document.querySelector("#alert").appendChild(alert);
    }

    async function registrarLog(metodo, retorno) {
        const urlLogs = `https://www.piway.com.br/unoesc/api/inserir/log/${matricula}/OpenWeather/${metodo}/${retorno}`;

        try {
            const response = await fetch(urlLogs);
            if (!response.ok) {
                throw new Error('Erro ao registrar log.');
            }
        } catch (error) {
            console.error('Erro ao registrar log:', error.message);
        }
    }

    async function fetchLogs() {
        const urlLogs = `https://www.piway.com.br/unoesc/api/logs/${matricula}`;

        try {
            const response = await fetch(urlLogs);
            if (!response.ok) {
                throw new Error('Matrícula do aluno é inválida.');
            }
            const logs = await response.json();
            displayLogs(logs);
        } catch (error) {
            mostrarAlerta(error.message);
        }
    }

    function displayLogs(logs) {
        const logsContainer = document.getElementById('logs-container');
        logsContainer.innerHTML = '';

        logs.forEach(log => {
            const logElement = document.createElement('div');
            logElement.className = 'log-entry d-flex justify-content-between align-items-center mb-2';
            logElement.innerHTML = `<p class="text-white">ID: ${log.idlog}<br> Data: ${log.log}<br> API: ${log.api}<br> Método: ${log.metodo}<br> Resultado: ${log.resultado}</p>
                                    <button class="btn btn-danger btn-sm" onclick="deleteLog('${log.idlog}')">Excluir</button>`;
            logsContainer.appendChild(logElement);
        });
    }

    async function deleteLog(idLog) {
        const urlDeleteLog = await fetch(`https://www.piway.com.br/unoesc/api/excluir/log/${idLog}/aluno/${matricula}`);

            
           
            fetchLogs(); // Atualiza a lista de logs após a exclusão
       
        
    }

    window.onload = inicio;
</script>
</body>

</html>
